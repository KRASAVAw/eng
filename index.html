<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашка</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #FFF9FB;
            --card-bg: #ffffff;<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Дашка</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lora:wght@500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #FFF9FB;
            --card-bg: #ffffff;
            --primary-color: #F472B6;
            --primary-hover: #EC4899;
            --text-color: #585064;
            --text-muted: #A8A0B5;
            --border-color: #FCE7F3;
            --correct-color: #10B981;
            --incorrect-color: #EF4444;
            --shadow: 0 10px 30px rgba(236, 72, 153, 0.15);
            --font-heading: 'Lora', serif;
            --font-body: 'Nunito', sans-serif;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23FBCFE8' fill-opacity='0.4'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        .container {
            position: relative;
            background: var(--card-bg);
            padding: 35px 40px;
            border-radius: 24px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 550px;
            text-align: center;
            border: 1px solid var(--border-color);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp 0.7s ease-out forwards;
        }
        
        .container::before, .container::after {
            content: '';
            position: absolute;
            width: 100px;
            height: 100px;
            background-repeat: no-repeat;
            background-size: contain;
            opacity: 0.3;
            pointer-events: none;
        }
        .container::before {
            top: -20px;
            left: -20px;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50,10 A20,20 0 0,1 70,30 A20,20 0 0,1 50,50 A20,20 0 0,1 30,30 A20,20 0 0,1 50,10' fill='%23EC4899'/%3E%3Cpath d='M30,70 A20,20 0 0,1 50,90 A20,20 0 0,1 30,70' fill='%23F472B6'/%3E%3Cpath d='M70,70 A20,20 0 0,1 90,50 A20,20 0 0,1 70,70' fill='%23F472B6'/%3E%3Ccircle cx='50' cy='30' r='5' fill='%23fff'/%3E%3C/svg%3E");
        }
        .container::after {
            bottom: -20px;
            right: -20px;
            transform: rotate(180deg);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Cpath d='M50,10 A20,20 0 0,1 70,30 A20,20 0 0,1 50,50 A20,20 0 0,1 30,30 A20,20 0 0,1 50,10' fill='%23EC4899'/%3E%3Cpath d='M30,70 A20,20 0 0,1 50,90 A20,20 0 0,1 30,70' fill='%23F472B6'/%3E%3Cpath d='M70,70 A20,20 0 0,1 90,50 A20,20 0 0,1 70,70' fill='%23F472B6'/%3E%3Ccircle cx='50' cy='30' r='5' fill='%23fff'/%3E%3C/svg%3E");
        }

        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

        h1 {
            font-family: var(--font-heading);
            margin-top: 0;
            margin-bottom: 30px;
            font-weight: 700;
            color: var(--primary-hover);
        }

        .view { transition: opacity 0.5s ease, transform 0.5s ease; }
        .hidden-view { position: absolute; opacity: 0; transform: scale(0.95); pointer-events: none; width: calc(100% - 80px); }

        .setting-group { text-align: left; margin-bottom: 20px; }
        .setting-group.hidden { display: none; } /* Helper class to hide elements */
        .setting-group label {
            margin-bottom: 10px; font-weight: 700; font-size: 14px;
            color: var(--text-muted); display: block;
        }
        .label-with-value { display: flex; justify-content: space-between; align-items: center; }

        select, button, input {
            width: 100%; padding: 14px 16px; border-radius: 12px;
            font-size: 16px; font-family: var(--font-body); box-sizing: border-box;
            background-color: #fff; color: var(--text-color);
            border: 2px solid var(--border-color);
            transition: all 0.25s ease-out;
        }

        select:disabled {
            background-color: #f8f8f8;
            opacity: 0.6;
            cursor: not-allowed;
        }

        select:focus, input:focus {
            outline: none; border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(244, 114, 182, 0.2);
        }
        
        button {
            background: var(--primary-color); color: white; border: none;
            cursor: pointer; font-weight: 700; font-size: 18px;
            transform: translateY(0); margin-top: 20px;
        }
        button:hover {
            background: var(--primary-hover);
            box-shadow: 0 5px 15px rgba(236, 72, 153, 0.3);
            transform: translateY(-3px);
        }
        
        input[type="range"] {
            -webkit-appearance: none; appearance: none; background: transparent; cursor: pointer; padding: 0;
        }
        input[type="range"]::-webkit-slider-runnable-track {
            background: var(--border-color); height: 8px; border-radius: 4px;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; margin-top: -6px;
            background-color: var(--primary-color); height: 20px; width: 20px;
            border-radius: 50%;
        }

        #progress-tracker { color: var(--text-muted); font-weight: 700; margin-bottom: 15px; }

        #word-container {
            padding: 25px; background-color: var(--bg-color); border-radius: 16px; margin-bottom: 20px;
            border: 2px dashed var(--border-color);
        }
        #word-to-translate {
            font-family: var(--font-heading); font-size: 24px; /* Adjusted for longer sentences */ font-weight: 700;
            color: var(--text-color); min-height: 45px;
            transition: opacity 0.3s ease-in-out;
        }
        
        #answer-input { margin-bottom: 15px; }
        #answer-input.correct-glow { border-color: var(--correct-color); box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.2); }
        #answer-input.incorrect-glow { border-color: var(--incorrect-color); box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2); }
        
        .feedback {
            padding: 12px; border-radius: 12px; margin-top: 20px;
            font-weight: 700; font-size: 16px; min-height: 24px;
            opacity: 0; transform: scale(0.95); transition: all 0.3s ease-in-out;
        }
        .feedback.visible { opacity: 1; transform: scale(1); }
        .feedback.correct { background-color: #F0FDF4; color: var(--correct-color); }
        .feedback.incorrect { background-color: #FEF2F2; color: var(--incorrect-color); }

        .shake-animation { animation: shake 0.5s ease-in-out; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        
        #score-area {
            margin-top: 35px; padding-top: 25px; border-top: 2px solid var(--border-color);
            display: flex; justify-content: space-around;
        }
        .score-item { display: flex; flex-direction: column; }
        .score-label { color: var(--text-muted); font-size: 14px; font-weight: 700; }
        .score-value { font-weight: 700; font-size: 24px; transition: transform 0.2s ease-out; }
        .score-pop { transform: scale(1.2); }
        #score-correct { color: var(--correct-color); }
        #score-incorrect { color: var(--incorrect-color); }
        #score-total { color: var(--primary-color); }
    </style>
</head>
<body>

    <div class="container" id="container">
        <h1>Дашка</h1>
        
        <div class="settings-view view" id="settings-view">
            <div class="setting-group" id="level-group">
                <label for="level-select">Уровень сложности</label>
                <select id="level-select">
                    <option value="A1">A1 (Beginner)</option>
                    <option value="A2">A2 (Elementary)</option>
                    <option value="B1">B1 (Intermediate)</option>
                    <option value="B2">B2 (Upper-Intermediate)</option>
                    <option value="C1">C1 (Advanced)</option>
                    <option value="C2">C2 (Proficiency)</option>
                </select>
            </div>
            <div class="setting-group">
                <label for="mode-select">Режим игры</label>
                <select id="mode-select">
                    <option value="en-ru">Английский -> Русский</option>
                    <option value="ru-en">Русский -> Английский</option>
                    <option value="mixed">Смешанный</option>
                    <option value="animals">Тема: Животные</option>
                    <option value="going-to-be-A1">Тест: "be going to" (A1)</option>
                    <option value="going-to-be">Тест: "be going to" (B1)</option>
                </select>
            </div>
            
            <div class="setting-group hidden" id="going-to-mode-group">
                <label for="going-to-mode-select">Направление теста</label>
                <select id="going-to-mode-select">
                    <option value="ru-en">Русский -> Английский</option>
                    <option value="en-ru">Английский -> Русский</option>
                    <option value="mixed">Смешанный</option>
                </select>
            </div>

            <div class="setting-group">
                <div class="label-with-value">
                    <label for="word-count-slider" id="word-count-label">Количество слов</label>
                    <span id="word-count-display">25</span>
                </div>
                <input type="range" id="word-count-slider" min="10" max="100" value="25">
            </div>
            <button id="start-button">Начать Тренировку</button>
        </div>

        <div class="game-view view hidden-view" id="game-view">
            <p id="progress-tracker">Вопрос <span id="current-word-number"></span> из <span id="total-word-number"></span></p>
            <div id="word-container"><p id="word-to-translate"></p></div>
            <input type="text" id="answer-input" placeholder="Введите ваш перевод..." autocomplete="off">
            <button id="action-button">Проверить</button>
            <div id="feedback" class="feedback"></div>
            <div id="score-area">
                <div class="score-item"><span class="score-label">Правильно</span><span id="score-correct" class="score-value">0</span></div>
                <div class="score-item"><span class="score-label">Неправильно</span><span id="score-incorrect" class="score-value">0</span></div>
                <div class="score-item"><span class="score-label">Всего</span><span id="score-total" class="score-value">0</span></div>
            </div>
            <button id="back-button" style="margin-top: 30px; background: none; border: 2px solid var(--border-color); color: var(--text-muted); font-size: 16px;">Закончить</button>
        </div>

        <div class="level-complete-view view hidden-view" id="level-complete-view">
            <h2>🌸 Сессия завершена! 🌸</h2>
            <p>Отличная работа! Вы можете начать заново с другими настройками.</p>
            <button id="restart-button">Начать заново</button>
        </div>
    </div>

    <!-- IMPORTANT: Load the database file BEFORE the main logic script -->
    <script src="database.js"></script>

    <script>
        const settingsView = document.getElementById('settings-view');
        const gameView = document.getElementById('game-view');
        const levelCompleteView = document.getElementById('level-complete-view');
        
        const levelGroup = document.getElementById('level-group');
        const levelSelect = document.getElementById('level-select');
        const modeSelect = document.getElementById('mode-select');
        const goingToModeGroup = document.getElementById('going-to-mode-group');
        const goingToModeSelect = document.getElementById('going-to-mode-select');

        const wordCountSlider = document.getElementById('word-count-slider');
        const wordCountDisplay = document.getElementById('word-count-display');
        const wordCountLabel = document.getElementById('word-count-label');
        const startButton = document.getElementById('start-button');
        const backButton = document.getElementById('back-button');
        const restartButton = document.getElementById('restart-button');
        const currentWordNumberElem = document.getElementById('current-word-number');
        const totalWordNumberElem = document.getElementById('total-word-number');
        const wordToTranslateElem = document.getElementById('word-to-translate');
        const answerInput = document.getElementById('answer-input');
        const actionButton = document.getElementById('action-button');
        const feedbackElem = document.getElementById('feedback');
        const scoreCorrectElem = document.getElementById('score-correct');
        const scoreIncorrectElem = document.getElementById('score-incorrect');
        const scoreTotalElem = document.getElementById('score-total');

        let currentWord = null;
        let correctCount = 0;
        let incorrectCount = 0;
        let shuffledWords = [];
        let totalWordsInSession = 0;
        let gameState = 'answering'; // 'answering' or 'reviewing'

        function switchView(viewToShow) {
            [settingsView, gameView, levelCompleteView].forEach(view => {
                view.classList.toggle('hidden-view', view.id !== viewToShow.id);
            });
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function startGame() {
            const mode = modeSelect.value;
            let fullWordList;

            // Determine which list of words/phrases to use
            if (mode === 'animals') {
                fullWordList = [...wordDatabase.animals];
            } else if (mode === 'going-to-be') {
                fullWordList = [...wordDatabase.goingToBePaired];
            } else if (mode === 'going-to-be-A1') {
                fullWordList = [...wordDatabase.goingToBeA1];
            } else {
                fullWordList = [...wordDatabase[levelSelect.value]];
            }
            
            const desiredCount = parseInt(wordCountSlider.value, 10);
            const sessionWordCount = Math.min(desiredCount, fullWordList.length);
            shuffledWords = shuffleArray(fullWordList).slice(0, sessionWordCount);
            
            totalWordsInSession = shuffledWords.length;
            totalWordNumberElem.textContent = totalWordsInSession;
            
            correctCount = 0; incorrectCount = 0;
            updateScore();
            switchView(gameView);
            generateNewWord();
        }

        function generateNewWord() {
            if (shuffledWords.length === 0) {
                switchView(levelCompleteView);
                return;
            }
            resetForNextRound();
            const wordPair = shuffledWords.pop();
            currentWordNumberElem.textContent = totalWordsInSession - shuffledWords.length;
            
            let effectiveMode = modeSelect.value;
            
            // For special modes, determine the translation direction
            if (effectiveMode.startsWith('going-to-be')) {
                let direction = goingToModeSelect.value;
                effectiveMode = (direction === 'mixed') ? (Math.random() < 0.5 ? 'en-ru' : 'ru-en') : direction;
            } else if (effectiveMode === 'animals') {
                effectiveMode = 'en-ru';
            } else if (effectiveMode === 'mixed') {
                effectiveMode = Math.random() < 0.5 ? 'en-ru' : 'ru-en';
            }

            // Set the question and answer based on the direction
            if (effectiveMode === 'en-ru') {
                wordToTranslateElem.textContent = wordPair.en[0]; // Display the first English variant
                currentWord = { 
                    source: wordPair.en[0], 
                    answer: wordPair.ru, 
                    displayAnswer: wordPair.ru.join(' / ') 
                };
            } else { // ru-en
                wordToTranslateElem.textContent = wordPair.ru[0]; // Display the first Russian variant
                currentWord = { 
                    source: wordPair.ru[0], 
                    answer: wordPair.en, 
                    displayAnswer: wordPair.en.join(' / ') 
                };
            }
            
            requestAnimationFrame(() => {
                wordToTranslateElem.style.opacity = '1';
            });
        }
        
        function normalizeAnswer(answer) {
             return answer.trim()
                         .toLowerCase()
                         .replace(/[.,!?']/g, '') // Also remove apostrophes for comparison
                         .replace(/\s+/g, ' ');
        }

        function checkAnswer() {
            const userAnswer = normalizeAnswer(answerInput.value);
            if (!userAnswer) return;

            // Normalize all possible correct answers for comparison
            const correctAnswers = currentWord.answer.map(normalizeAnswer);

            if (correctAnswers.includes(userAnswer)) {
                correctCount++;
                feedbackElem.innerHTML = `✅ Правильно! Возможные ответы: <strong>${currentWord.displayAnswer}</strong>`;
                feedbackElem.className = 'feedback correct visible';
                answerInput.classList.add('correct-glow');
                animateScore(scoreCorrectElem);
            } else {
                incorrectCount++;
                feedbackElem.innerHTML = `❌ Неверно. Правильный ответ: <strong>${currentWord.displayAnswer}</strong>`;
                feedbackElem.className = 'feedback incorrect visible';
                answerInput.classList.add('incorrect-glow', 'shake-animation');
                setTimeout(() => answerInput.classList.remove('shake-animation'), 500);
                animateScore(scoreIncorrectElem);
            }
            animateScore(scoreTotalElem);
            updateScore();
            gameState = 'reviewing';
            answerInput.disabled = true;
            actionButton.textContent = 'Следующее';
            actionButton.focus();
        }
        
        function updateScore() {
            scoreCorrectElem.textContent = correctCount;
            scoreIncorrectElem.textContent = incorrectCount;
            scoreTotalElem.textContent = correctCount + incorrectCount;
        }

        function animateScore(element) {
            element.classList.add('score-pop');
            setTimeout(() => element.classList.remove('score-pop'), 200);
        }

        function resetForNextRound() {
            gameState = 'answering';
            answerInput.value = '';
            answerInput.disabled = false;
            answerInput.className = '';
            feedbackElem.classList.remove('visible', 'correct', 'incorrect');
            actionButton.textContent = 'Проверить';
            answerInput.focus();
        }
        
        function returnToMenu() {
            switchView(settingsView);
        }
        
        function updateSlider() {
            const value = wordCountSlider.value;
            wordCountDisplay.textContent = value;
            const percentage = (value - wordCountSlider.min) / (wordCountSlider.max - wordCountSlider.min) * 100;
            wordCountSlider.style.background = `linear-gradient(to right, var(--primary-color) ${percentage}%, var(--border-color) ${percentage}%)`;
        }

        function handleActionClick() {
            if (gameState === 'answering') {
                checkAnswer();
            } else { 
                wordToTranslateElem.style.opacity = '0';
                setTimeout(generateNewWord, 300);
            }
        }
        
        document.addEventListener('keydown', function(event) {
            if (event.key !== 'Enter') return;
            if (gameView.classList.contains('hidden-view')) return;
            event.preventDefault();
            if (document.activeElement === actionButton || document.activeElement === answerInput) {
                 handleActionClick();
            }
        });
        
        function updateSettingsUI() {
            const mode = modeSelect.value;
            const isGrammarTest = mode.startsWith('going-to-be');
            const isAnimals = (mode === 'animals');

            // Show/hide level selection
            levelGroup.classList.toggle('hidden', isAnimals || isGrammarTest);

            // Show/hide "going to" direction selection
            goingToModeGroup.classList.toggle('hidden', !isGrammarTest);

            // Change slider label
            wordCountLabel.textContent = (isAnimals || isGrammarTest) ? 'Количество предложений' : 'Количество слов';

            // Adjust slider settings
            if (mode === 'going-to-be-A1') {
                wordCountSlider.min = 5;
                wordCountSlider.max = 30; // Max available sentences for A1
                if (parseInt(wordCountSlider.value) > 30 || parseInt(wordCountSlider.value) < 5) wordCountSlider.value = 10;
            } else if (mode === 'going-to-be') {
                wordCountSlider.min = 10;
                wordCountSlider.max = 50; // Max available sentences for B1
                if (parseInt(wordCountSlider.value) > 50) wordCountSlider.value = 20;
            } else {
                wordCountSlider.min = 10;
                wordCountSlider.max = 100;
                wordCountSlider.value = 25;
            }
            updateSlider();
        }

        // Event Listeners
        startButton.addEventListener('click', startGame);
        backButton.addEventListener('click', returnToMenu);
        restartButton.addEventListener('click', returnToMenu);
        actionButton.addEventListener('click', handleActionClick);
        wordCountSlider.addEventListener('input', updateSlider);
        modeSelect.addEventListener('change', updateSettingsUI); 
        document.addEventListener('DOMContentLoaded', updateSettingsUI);
    </script>
</body>
</html>